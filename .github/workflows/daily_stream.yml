name: Daily Stream Check

on:
  schedule:
    # 8:00 AM IST = 02:30 UTC
    - cron: '30 2 * * *'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target Platform'
        required: true
        default: 'facebook'
        type: choice
        options:
        - facebook
        - instagram

jobs:
  check-and-stream:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Set up Node.js (required by yt-dlp)
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        python -m pip install --upgrade pip
        pip install --upgrade yt-dlp
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        echo "yt-dlp version:" && yt-dlp --version
        echo "node version:" && node --version

    - name: Setup Cookies
      env:
        COOKIES: ${{ secrets.YOUTUBE_COOKIES }}
      run: |
        if [ -n "$COOKIES" ]; then
          printf "%s" "$COOKIES" > cookies.txt
          echo "cookies.txt created ($(wc -l < cookies.txt) lines, $(wc -c < cookies.txt) bytes)"
        else
          echo "WARNING: No YOUTUBE_COOKIES secret set!"
        fi

    - name: Run Auto Streamer
      env:
        YOUTUBE_URL: ${{ secrets.YOUTUBE_URL }}
        FB_STREAM_KEY: ${{ secrets.FB_STREAM_KEY }}
      run: |
        python autostream.py
